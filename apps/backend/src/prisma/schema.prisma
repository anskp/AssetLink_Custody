// This is your Prisma schema file for AssetLink Custody
// Database: MySQL
// Core tables: CustodyRecord, CustodyOperation, AuditLog, ApiKey, VaultWallet

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// API Authentication
model ApiKey {
  id            String   @id @default(uuid())
  publicKey     String   @unique
  secretKeyHash String   // HMAC secret (hashed)
  secretKey     String?  // Plain secret key for HMAC verification (stored temporarily/dev)
  tenantId      String?
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  role          String   @default("MAKER") // MAKER, CHECKER, VIEWER
  permissions   Json     // Scoped permissions array
  ipWhitelist   Json?    // Optional IP restrictions
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([publicKey])
  @@index([userId])
  @@map("api_keys")
}

// User Accounts
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  role          String   @default("CLIENT") // CLIENT, ADMIN
  status        String   @default("ACTIVE") // ACTIVE, SUSPENDED
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  apiKeys          ApiKey[]
  balance          UserBalance?
  
  @@map("users")
}

// Fireblocks Vault Metadata
model VaultWallet {
  id              String   @id @default(uuid())
  fireblocksId    String   // Fireblocks vault ID (not unique - one vault has multiple wallets)
  blockchain      String   // ETH, MATIC, etc.
  address         String?  // Wallet address for this blockchain
  vaultType       String   // CUSTODY, SETTLEMENT
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  custodyRecords  CustodyRecord[]
  operations      CustodyOperation[]

  @@unique([fireblocksId, blockchain])
  @@index([fireblocksId])
  @@map("vault_wallets")
}

// Core Custody Record (Asset-to-Token Immutable Mapping)
model CustodyRecord {
  id                String   @id @default(uuid())
  assetId           String   @unique // External asset identifier (immutable)
  status            String   // UNLINKED, LINKED, MINTED, WITHDRAWN, BURNED
  
  // Two-level isolation
  tenantId          String   // Platform owner (from API key)
  createdBy         String   // End user who created this record
  
  // Token metadata (populated after minting)
  blockchain        String?
  tokenStandard     String?  // ERC721, ERC1155
  tokenAddress      String?
  tokenId           String?
  quantity          String?  // Decimal string for precision
  
  // Vault reference
  vaultWalletId     String?
  vaultWallet       VaultWallet? @relation(fields: [vaultWalletId], references: [id])
  
  // Timestamps
  linkedAt          DateTime?
  mintedAt          DateTime?
  withdrawnAt       DateTime?
  burnedAt          DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  operations        CustodyOperation[]
  auditLogs         AuditLog[]
  assetMetadata     AssetMetadata?
  listings          Listing[]
  ownerships        Ownership[]

  // Explorer identifiers
  publicContractAddress String?  @unique // alca_<chain>_<short-hash>

  @@index([assetId])
  @@index([tenantId])
  @@index([createdBy])
  @@index([status])
  @@map("custody_records")
}

// Asset Metadata (Detailed Asset Information)
model AssetMetadata {
  id                String   @id @default(uuid())
  custodyRecordId   String   @unique
  custodyRecord     CustodyRecord @relation(fields: [custodyRecordId], references: [id])
  
  // Asset Information
  assetType         String   // WATCH, JEWELRY, ART, REAL_ESTATE, etc.
  assetName         String
  description       String?  @db.Text
  manufacturer      String?
  model             String?
  serialNumber      String?
  yearManufactured  Int?
  
  // Valuation
  estimatedValue    String   // Existing field (default to USD)
  estimatedValueUsd String?  // New USD field
  estimatedValueEth String?  // New ETH field
  currency          String   @default("USD")
  valuationDate     DateTime?
  valuationMethod   String?
  
  // Verification
  verifiedBy        String?
  verificationDate  DateTime?
  verificationNotes String?  @db.Text
  
  // Documents and Images
  documents         Json     // Array of document references
  images            Json     // Array of image URLs
  assetFiles        AssetFile[]
  
  // Storage and Custody
  storageType       String?  // Issuer Custody, Platform Custody, etc.
  
  // Custom metadata
  customFields      Json?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([assetType])
  @@index([custodyRecordId])
  @@map("asset_metadata")
}

// Asset Files (Detailed File Tracking)
model AssetFile {
  id                String   @id @default(uuid())
  assetMetadataId   String
  assetMetadata     AssetMetadata @relation(fields: [assetMetadataId], references: [id])
  fileType          String   // OWNERSHIP, IMAGE, VIDEO
  filePath          String
  mimeType          String?
  uploadedAt        DateTime @default(now())

  @@index([assetMetadataId])
  @@map("asset_files")
}

// Maker-Checker Operations
model CustodyOperation {
  id                  String   @id @default(uuid())
  operationType       String   // MINT, TRANSFER, BURN
  status              String   // PENDING_MAKER, PENDING_CHECKER, APPROVED, EXECUTED, REJECTED, FAILED
  
  // References
  custodyRecordId     String?
  custodyRecord       CustodyRecord? @relation(fields: [custodyRecordId], references: [id])
  
  vaultWalletId       String?
  vaultWallet         VaultWallet? @relation(fields: [vaultWalletId], references: [id])
  
  // Operation payload
  payload             Json     // Operation-specific data
  
  // Approval tracking
  initiatedBy         String   // Maker user ID
  approvedBy          String?  // Checker user ID
  rejectedBy          String?
  rejectionReason     String?  @db.Text
  
  // Execution tracking
  fireblocksTaskId    String?  @unique
  txHash              String?
  executedAt          DateTime?
  failureReason       String?  @db.Text
  
  // Idempotency
  idempotencyKey      String?  @unique
  
  // Explorer identifier
  offchainTxHash      String?  @unique // altx_<sha256_hash>

  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  auditLogs           AuditLog[]

  @@index([custodyRecordId])
  @@index([status])
  @@index([operationType])
  @@index([fireblocksTaskId])
  @@index([offchainTxHash])
  @@map("custody_operations")
}

// Append-Only Audit Trail
model AuditLog {
  id                  String   @id @default(uuid())
  
  // References
  custodyRecordId     String?
  custodyRecord       CustodyRecord? @relation(fields: [custodyRecordId], references: [id])
  
  operationId         String?
  operation           CustodyOperation? @relation(fields: [operationId], references: [id])
  
  // Event details
  eventType           String   // ASSET_LINKED, TOKEN_MINTED, TRANSFER_EXECUTED, etc.
  actor               String   // User/system that triggered the event
  metadata            Json     // Event-specific data
  ipAddress           String?
  userAgent           String?  @db.Text
  
  // Timestamp (immutable)
  timestamp           DateTime @default(now())

  @@index([custodyRecordId])
  @@index([operationId])
  @@index([eventType])
  @@index([timestamp])
  @@map("audit_logs")
}

// Marketplace Listing
model Listing {
  id                String   @id @default(uuid())
  assetId           String
  custodyRecordId   String
  custodyRecord     CustodyRecord @relation(fields: [custodyRecordId], references: [id])
  
  // Two-level isolation
  tenantId          String   // Platform owner
  sellerId          String   // End user (issuer)
  
  price             String   // Existing field (default to USD)
  priceUsd          String?  // New USD price
  priceEth          String?  // New ETH price
  currency          String   @default("USD")
  quantityListed    String   // Total quantity listed
  quantitySold      String   @default("0") // Quantity sold
  
  status            String   // ACTIVE, SOLD, CANCELLED, EXPIRED
  
  expiryDate        DateTime
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  bids              Bid[]

  @@index([assetId])
  @@index([tenantId])
  @@index([sellerId])
  @@index([status])
  @@index([expiryDate])
  @@map("listings")
}

// Marketplace Bid
model Bid {
  id                String   @id @default(uuid())
  listingId         String
  listing           Listing  @relation(fields: [listingId], references: [id])
  
  // Two-level isolation
  tenantId          String   // Platform owner
  buyerId           String   // End user (investor)
  
  amount            String   // Decimal string for precision
  quantity          String   // Quantity of tokens
  status            String   // PENDING, ACCEPTED, REJECTED
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([listingId])
  @@index([tenantId])
  @@index([buyerId])
  @@index([status])
  @@map("bids")
}

// Off-Chain Ownership Ledger
model Ownership {
  id                String   @id @default(uuid())
  assetId           String
  custodyRecordId   String
  custodyRecord     CustodyRecord @relation(fields: [custodyRecordId], references: [id])
  
  // Two-level isolation
  tenantId          String   // Platform owner
  ownerId           String   // End user (investor)
  
  quantity          String   // Decimal string for precision
  purchasePrice     String?  // Existing field (default to USD)
  purchasePriceUsd  String?  // New USD purchase price
  purchasePriceEth  String?  // New ETH purchase price
  currency          String   @default("USD")
  walletAddress     String?  // Investor's wallet address for off-chain tracking
  
  acquiredAt        DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([assetId, ownerId])
  @@index([assetId])
  @@index([tenantId])
  @@index([ownerId])
  @@map("ownerships")
}

// User Account Balances (for marketplace settlement)
model UserBalance {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id])
  
  balance           String   // Decimal string for precision
  currency          String   @default("USD")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@map("user_balances")
}

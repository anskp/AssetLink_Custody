generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model ApiKey {
  id            String   @id @default(uuid())
  publicKey     String   @unique
  secretKeyHash String
  tenantId      String?
  permissions   Json
  ipWhitelist   Json?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  userId        String?
  role          String   @default("MAKER")
  secretKey     String?
  user          User?    @relation(fields: [userId], references: [id])

  @@index([publicKey])
  @@index([userId])
  @@map("api_keys")
}

model User {
  id           String       @id @default(uuid())
  email        String       @unique
  passwordHash String
  role         String       @default("CLIENT")
  status       String       @default("ACTIVE")
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  apiKeys      ApiKey[]
  balance      UserBalance?

  @@map("users")
}

model VaultWallet {
  id             String             @id @default(uuid())
  fireblocksId   String
  blockchain     String?
  vaultType      String
  isActive       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  address        String?
  operations     CustodyOperation[]
  custodyRecords CustodyRecord[]

  @@unique([fireblocksId, blockchain])
  @@index([fireblocksId])
  @@map("vault_wallets")
}

model CustodyRecord {
  id                    String             @id @default(uuid())
  assetId               String             @unique
  status                String
  blockchain            String?
  tokenStandard         String?
  tokenAddress          String?
  tokenId               String?
  quantity              String?
  vaultWalletId         String?
  linkedAt              DateTime?
  mintedAt              DateTime?
  withdrawnAt           DateTime?
  burnedAt              DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  createdBy             String
  tenantId              String
  publicContractAddress String?            @unique
  assetMetadata         AssetMetadata?
  auditLogs             AuditLog[]
  operations            CustodyOperation[]
  vaultWallet           VaultWallet?       @relation(fields: [vaultWalletId], references: [id])
  listings              Listing[]
  ownerships            Ownership[]

  @@index([assetId])
  @@index([tenantId])
  @@index([createdBy])
  @@index([status])
  @@index([vaultWalletId], map: "custody_records_vaultWalletId_fkey")
  @@map("custody_records")
}

model AssetMetadata {
  id                String        @id @default(uuid())
  custodyRecordId   String        @unique
  assetType         String
  assetName         String
  description       String?       @db.Text
  manufacturer      String?
  model             String?
  serialNumber      String?
  yearManufactured  Int?
  estimatedValue    String
  currency          String        @default("USD")
  valuationDate     DateTime?
  valuationMethod   String?
  verifiedBy        String?
  verificationDate  DateTime?
  verificationNotes String?       @db.Text
  documents         Json
  images            Json
  customFields      Json?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  storageType       String?
  estimatedValueEth String?
  estimatedValueUsd String?
  assetFiles        AssetFile[]
  custodyRecord     CustodyRecord @relation(fields: [custodyRecordId], references: [id])

  @@index([assetType])
  @@index([custodyRecordId])
  @@map("asset_metadata")
}

model AssetFile {
  id              String        @id @default(uuid())
  assetMetadataId String
  fileType        String
  filePath        String
  mimeType        String?
  uploadedAt      DateTime      @default(now())
  assetMetadata   AssetMetadata @relation(fields: [assetMetadataId], references: [id])

  @@index([assetMetadataId])
  @@map("asset_files")
}

model CustodyOperation {
  id               String         @id @default(uuid())
  operationType    String
  status           String
  custodyRecordId  String?
  vaultWalletId    String?
  payload          Json
  initiatedBy      String
  approvedBy       String?
  rejectedBy       String?
  rejectionReason  String?        @db.Text
  fireblocksTaskId String?        @unique
  txHash           String?
  executedAt       DateTime?
  failureReason    String?        @db.Text
  idempotencyKey   String?        @unique
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  offchainTxHash   String?        @unique
  fireblocksStatus String?
  auditLogs        AuditLog[]
  custodyRecord    CustodyRecord? @relation(fields: [custodyRecordId], references: [id])
  vaultWallet      VaultWallet?   @relation(fields: [vaultWalletId], references: [id])

  @@index([custodyRecordId])
  @@index([status])
  @@index([operationType])
  @@index([fireblocksTaskId])
  @@index([offchainTxHash])
  @@index([vaultWalletId], map: "custody_operations_vaultWalletId_fkey")
  @@map("custody_operations")
}

model AuditLog {
  id              String            @id @default(uuid())
  custodyRecordId String?
  operationId     String?
  eventType       String
  actor           String
  metadata        Json
  ipAddress       String?
  userAgent       String?           @db.Text
  timestamp       DateTime          @default(now())
  custodyRecord   CustodyRecord?    @relation(fields: [custodyRecordId], references: [id])
  operation       CustodyOperation? @relation(fields: [operationId], references: [id])

  @@index([custodyRecordId])
  @@index([operationId])
  @@index([eventType])
  @@index([timestamp])
  @@map("audit_logs")
}

model Listing {
  id              String        @id @default(uuid())
  assetId         String
  custodyRecordId String
  sellerId        String
  price           String
  currency        String        @default("USD")
  status          String
  expiryDate      DateTime
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  quantityListed  String
  quantitySold    String        @default("0")
  tenantId        String
  priceEth        String?
  priceUsd        String?
  bids            Bid[]
  custodyRecord   CustodyRecord @relation(fields: [custodyRecordId], references: [id])

  @@index([assetId])
  @@index([tenantId])
  @@index([sellerId])
  @@index([status])
  @@index([expiryDate])
  @@index([custodyRecordId], map: "listings_custodyRecordId_fkey")
  @@map("listings")
}

model Bid {
  id        String   @id @default(uuid())
  listingId String
  buyerId   String
  amount    String
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  quantity  String
  tenantId  String
  listing   Listing  @relation(fields: [listingId], references: [id])

  @@index([listingId])
  @@index([tenantId])
  @@index([buyerId])
  @@index([status])
  @@map("bids")
}

model Ownership {
  id               String        @id @default(uuid())
  assetId          String
  custodyRecordId  String
  ownerId          String
  quantity         String
  acquiredAt       DateTime      @default(now())
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  currency         String        @default("USD")
  purchasePrice    String?
  tenantId         String
  purchasePriceEth String?
  purchasePriceUsd String?
  walletAddress    String?
  custodyRecord    CustodyRecord @relation(fields: [custodyRecordId], references: [id])

  @@unique([assetId, ownerId])
  @@index([assetId])
  @@index([tenantId])
  @@index([ownerId])
  @@index([custodyRecordId], map: "ownerships_custodyRecordId_fkey")
  @@map("ownerships")
}

model UserBalance {
  id        String   @id @default(uuid())
  userId    String   @unique
  balance   String
  currency  String   @default("USD")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("user_balances")
}
